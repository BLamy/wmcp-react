<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin" />
  <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp" />
  <title>Cross-Origin Isolation Check</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
      line-height: 1.6;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      color: #333;
    }
    h1 {
      text-align: center;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    .status {
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    .success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .warning {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background-color: #0069d9;
    }
    code {
      font-family: monospace;
      background-color: #f5f5f5;
      padding: 2px 4px;
      border-radius: 3px;
    }
    #results {
      white-space: pre-wrap;
      background-color: #f5f5f5;
      padding: 15px;
      border-radius: 5px;
      overflow: auto;
      max-height: 300px;
    }
  </style>
  
  <!-- Import the service worker registration script -->
  <script src="./register-coi-sw.js"></script>
</head>
<body>
  <h1>Cross-Origin Isolation Check</h1>
  
  <div id="statusContainer"></div>
  
  <h2>Browser Support</h2>
  <div id="browserSupport"></div>
  
  <h2>Headers</h2>
  <div id="headersInfo"></div>
  
  <h2>Service Worker</h2>
  <div id="serviceWorkerInfo"></div>
  
  <h2>SharedArrayBuffer Test</h2>
  <div>
    <button id="testSharedArrayBuffer">Test SharedArrayBuffer</button>
    <div id="sabTestResult"></div>
  </div>
  
  <h2>Console Output</h2>
  <div id="results"></div>
  
  <script>
    // For capturing console logs to display in the UI
    const originalConsole = {
      log: console.log,
      warn: console.warn,
      error: console.error
    };
    
    const logMessages = [];
    
    // Override console methods to capture logs
    console.log = function() {
      logMessages.push(['log', ...arguments]);
      originalConsole.log.apply(console, arguments);
      updateResults();
    };
    
    console.warn = function() {
      logMessages.push(['warn', ...arguments]);
      originalConsole.warn.apply(console, arguments);
      updateResults();
    };
    
    console.error = function() {
      logMessages.push(['error', ...arguments]);
      originalConsole.error.apply(console, arguments);
      updateResults();
    };
    
    function updateResults() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = logMessages.map(msg => {
        const level = msg.shift();
        const text = msg.map(item => typeof item === 'object' ? JSON.stringify(item) : item).join(' ');
        return `<span class="${level}">[${level}] ${text}</span>`;
      }).join('<br>');
    }
    
    // Check cross-origin isolation status
    function checkCrossOriginIsolation() {
      const statusContainer = document.getElementById('statusContainer');
      const browserSupport = document.getElementById('browserSupport');
      const headersInfo = document.getElementById('headersInfo');
      const serviceWorkerInfo = document.getElementById('serviceWorkerInfo');
      
      // Check if cross-origin isolation is enabled
      const isIsolated = window.crossOriginIsolated;
      
      // Overall status
      if (isIsolated) {
        statusContainer.innerHTML = `
          <div class="status success">
            <strong>✅ Success!</strong> This page is cross-origin isolated.
          </div>
        `;
      } else {
        statusContainer.innerHTML = `
          <div class="status error">
            <strong>❌ Error!</strong> This page is NOT cross-origin isolated.
          </div>
        `;
      }
      
      // Browser support
      browserSupport.innerHTML = `
        <p>Cross-Origin Isolation: <code>${isIsolated ? 'Enabled' : 'Disabled'}</code></p>
        <p>SharedArrayBuffer: <code>${typeof SharedArrayBuffer === 'function' ? 'Available' : 'Not available'}</code></p>
      `;
      
      // Headers info
      headersInfo.innerHTML = `
        <p>The following headers should be set:</p>
        <ul>
          <li>Cross-Origin-Opener-Policy: same-origin</li>
          <li>Cross-Origin-Embedder-Policy: require-corp</li>
        </ul>
        <p>Note: We can't directly check the headers from JavaScript, but they're required for cross-origin isolation.</p>
      `;
      
      // Service worker info
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(registrations => {
          if (registrations.length > 0) {
            serviceWorkerInfo.innerHTML = `
              <div class="status success">
                <p>✅ Service worker registered:</p>
                <ul>
                  ${registrations.map(reg => `<li>Scope: <code>${reg.scope}</code></li>`).join('')}
                </ul>
              </div>
            `;
          } else {
            serviceWorkerInfo.innerHTML = `
              <div class="status warning">
                <p>⚠️ No service worker registered.</p>
              </div>
            `;
          }
        }).catch(error => {
          serviceWorkerInfo.innerHTML = `
            <div class="status error">
              <p>❌ Error checking service worker: ${error.message}</p>
            </div>
          `;
        });
      } else {
        serviceWorkerInfo.innerHTML = `
          <div class="status error">
            <p>❌ Service workers are not supported in this browser.</p>
          </div>
        `;
      }
    }
    
    // Test SharedArrayBuffer
    document.getElementById('testSharedArrayBuffer').addEventListener('click', function() {
      const sabTestResult = document.getElementById('sabTestResult');
      
      try {
        const sab = new SharedArrayBuffer(1024);
        const array = new Uint8Array(sab);
        array[0] = 42;
        
        sabTestResult.innerHTML = `
          <div class="status success">
            <p>✅ Successfully created a SharedArrayBuffer and wrote to it.</p>
            <p>array[0] = ${array[0]}</p>
          </div>
        `;
      } catch (e) {
        sabTestResult.innerHTML = `
          <div class="status error">
            <p>❌ Error creating SharedArrayBuffer: ${e.message}</p>
            <p>This likely means cross-origin isolation is not properly configured.</p>
          </div>
        `;
      }
    });
    
    // Run checks on page load
    window.addEventListener('DOMContentLoaded', function() {
      checkCrossOriginIsolation();
      
      // Log some diagnostic info
      console.log('Page loaded, running diagnostics...');
      console.log('crossOriginIsolated:', window.crossOriginIsolated);
      console.log('SharedArrayBuffer available:', typeof SharedArrayBuffer === 'function');
      
      if ('serviceWorker' in navigator) {
        console.log('Service workers are supported');
      } else {
        console.warn('Service workers are NOT supported');
      }
    });
  </script>
</body>
</html> 